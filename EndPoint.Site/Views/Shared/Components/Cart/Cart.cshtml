@using NewStore.Application.Services.Carts
@model GetCartDto
@{
    Layout = null;
}

<!-- Shoping cart -->
<button class="flex-center p-2 bg-blue-600 text-gray-100 rounded-full open-cart relative">
    <svg class="size-6">
        <use href="#shopping-bag"></use>
    </svg>
    <span class="absolute -top-1 -right-1 flex h-4 w-4">
        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-600 opacity-75"></span>
        <span class="relative inline-flex rounded-full h-4 w-4 bg-red-500 text-xs pt-1 flex-center text-white">@Model.CartItemsCount</span>
    </span>
</button>

<!-- Cart -->
<div class="cart loding-modal">

    <!-- HEADER -->
    <div class="flex items-center justify-between pb-2 border-b-2 border-gray-200 dark:border-gray-600 text-gray-800 dark:text-gray-300">
        <h2 class="font-DanaMedium text-lg">
            سبد خرید <span class="text-sm text-gray-400 font-Dana">
                (2
                مورد)
            </span>
        </h2>
        <svg class="size-5 cursor-pointer close-cart mb-.5">
            <use href="#x-mark"></use>
        </svg>
    </div>

    <!-- MAIN -->
    <div class="flex flex-col divide-y-2 divide-gray-200 dark:divide-gray-600 my-4">
        @if (Model.CartItemsCount > 0)
        {
            <!-- CART ITEMS -->
            @foreach (var item in Model.CartItems)
            {
                <div class="grid grid-cols-12 gap-x-2 w-full py-4 cursor-pointer">
                    <!-- img -->
                    <div class="col-span-4 w-24 h-20">
                        <img src="~/@item.ProductSrc" class="rounded-lg" alt="product">
                    </div>
                    <!-- detail -->
                    <div class="col-span-8 flex flex-col justify-between">
                        <h2 class="font-DanaMedium line-clamp-2">@item.ProductName </h2>
                        <div class="flex items-center justify-between gap-x-2 mt-2">
                            <button class="w-20 flex items-center justify-between gap-x-1 rounded-lg border border-gray-200 dark:border-white/20 py-1 px-2">
                                <svg class="size-4 increment text-green-600">
                                    <use href="#plus"></use>
                                </svg>
                                <input type="number" name="customInput" id="inp_@item.CartItemId" min="0" value="@item.Count" class="custom-input w-4 mr-2 text-sm">
                                <svg class="size-4 decrement text-red-500">
                                    <use href="#minus"></use>
                                </svg>
                            </button>
                            <p class="text-lg text-blue-500 dark:text-blue-400 font-DanaMedium">
                                @item.Price
                                <span class="font-Dana text-sm">تومان</span>
                            </p>
                        </div>
                    </div>
                </div>
            }
}
    </div>
    <!-- FOOTER -->
    <div class="w-[90%] fixed bottom-2 flex items-center justify-between border-t-2 border-gray-200 dark:border-gray-600 pt-4">
        <div>
            <p class="text-gray-500 dark:text-gray-300 text-sm">مبلغ قابل پرداخت :</p>
            <p class="text-lg text-blue-500 dark:text-blue-400 font-DanaDemiBold">
                1,130,000
                <span class="font-Dana text-sm">تومان</span>
            </p>
        </div>
        <a id="btnSubmit" class="py-2 px-4 bg-blue-600 flex-center hover:bg-blue-700 transition-all rounded-lg text-gray-200">
            ثبت سفارش
        </a>
    </div>
</div>
<script src="~/Scripts/jquery-3.7.1.min.js"></script>
<script>
    document.getElementById("btnSubmit").addEventListener('click', goToCart);

    function goToCart() {

        var cartItems = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.CartItems));

        // Map to CountCartItemDto: only CartItemId + Count
        var updatedCartItems = cartItems.map(item => {
            var inputVal = document.getElementById("inp_" + item.CartItemId).value;
            return {
                CartItemId: item.CartItemId,
                Count: parseInt(inputVal) || 0
            };
        });

        // Send updated counts to controller
        fetch('/Cart/DirectToCart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedCartItems)
        })
        .then(res => res.json())
        .then(data => {
            if (data.redirectUrl) {
                window.location.href = data.redirectUrl;
            }
        })
        .catch(err => console.error(err));
    }
</script>
